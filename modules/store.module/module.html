{% if dynamic_page_hubdb_row %}
	{% require_js position="footer" %}
		<script>
			let productQuantity = 1;

			function decreaseValue() {
				const countDisplay = document.getElementById('product__count');
				
				if (productQuantity > 1) {
					countDisplay.value = --productQuantity;
				}
			}

			function increaseValue() {
				document.getElementById('product__count').value = ++productQuantity;
			}

			function addToCart() {
				const count = document.getElementById('product__count').value;
				const cart = document.getElementById('shopify__cart');
				for (let i = 0; i < count; i++) {
					cart.addLine(event);
				}

				cart.showModal();
			}
		</script>
	{% end_require_js %}

	{% set product = dynamic_page_hubdb_row %}
	<section class="product">
		<div class="content-wrapper">
			<shopify-store
				id="shopify-store"
				store-domain="https://sigmetrix.myshopify.com/"
			></shopify-store>

			<shopify-cart id="shopify__cart" target="_blank"></shopify-cart>

			<div class="product__hero">
				<div class="product__media">
					<img
						class="product__img"
						src="{{ product.image.url }}"
						alt="{{ product.image.altText }}"
						height="216"
						width="384"
					>
				</div>
				<div class="product__info">
					<div class="product__content-wrapper">
						<h1 class="product__name">
							{{ product.name }}
						</h1>
						<p class="product__price">
							{{ product.price|format_currency_value(locale='en-US', currency='USD', maxDecimalDigits=6, minDecimalDigits=2) }} USD
						</p>
						<div class="product__short-description">
							{{ product.short_description }}
						</div>
					</div>
					<div class="product__buy">
						<shopify-context
							type="product"
							handle="{{ product.hs_path }}"
						>
							<template>
								<div class="product__quantity">
									<label class="product__quantity-label" for="product__count">Quantity</label>
									<div class="product__quantity-input">
										<button class="btn--decrease" onclick="decreaseValue()">-</button>
										<input type="number" class="product__count" id="product__count" name="quantity" min="1" max="null" value="1" step="1">
										<button class="btn--increase" onclick="increaseValue()">+</button>
									</div>
								</div>
								<div class="product__buy-buttons">
									<button
										class="btn--add-to-cart btn--outline btn--small"
										onclick="addToCart()"
									>
										Add to cart
									</button>
									<button
										class="btn--buy-now btn--secondary btn--small"
										onclick="getElementById('shopify-store').buyNow(event, {target: '_blank'});"
									>
										Buy now
									</button>
								</div>
							</template>
						</shopify-context>
					</div>
				</div>
			</div>
			<div class="product__description-wrapper">
				<h2 class="product__description-title">
					Course Description
				</h2>
				<div class="product__description">
					{{ product.description }}
					
					{% unless product.description %}
						{{ product.short_description }}
					{% endunless %}
				</div>
			</div>
			
			{# Query HubDB by category with limit #}
			{% set query_options = "category__contains=" ~ product.category|split('>')|first ~ "&name__not_like=" ~ product.name ~ "&limit=3" %}

			{% set table = hubdb_table_rows(
				dynamic_page_hubdb_table_id,
				query_options
			) %}

			{% if table|length %}
				<div class="product__recommended-wrapper">
					<h2 class="product__recommended-title">
						Related Courses
					</h2>
					<div class="store__products">
						{% for row in table %}
							<div
								id="store__product"
								class="store__product"
							>
								<div class="store__product-media">
									<a class="store__product-img-wrapper" href="/{{request.path|split('/')|first}}/{{row.hs_path}}">
										<img
											class="store__product-img"
											src="{{ row.image.url }}"
											alt="{{ row.image.altText }}"
											height="216"
											width="384"
										>
									</a>
								</div>
								<div class="store__product-content">
									<h2 class="store__product-title">
										<a class="store__product-link" href="/{{request.path|split('/')|first}}/{{row.hs_path}}">
											{{ row.hs_name }}
										</a>
									</h2>
									<p class="store__product-price">
										{{ row.price|format_currency_value(locale='en-US', currency='USD', maxDecimalDigits=6, minDecimalDigits=2) }} USD
									</p>
									<div class="store__product-desc">
										{{ row.short_description }}
									</div>
								</div>
								<div class="store__product-cta">
									<a class="btn--store btn--outline-secondary btn--small" href="/{{request.path|split('/')|first}}/{{row.hs_path}}">
										Learn More
									</a>
								</div>
							</div>
						{% endfor %}
					</div>
				</div>
			{% endif %}
		</div>
	</section>
	
{% elif dynamic_page_hubdb_table_id %}

	{% set current_page = request.query_dict.page|default(1)|int %}
	{% set category = request.query_dict.category|default('') %}
	
	{# Pagination variables #}
	{% set rows_per_page = 9 %}
	{% set offset = (current_page - 1) * rows_per_page %}

	{# Dynamic query options for category queries #}
	{% set query_options = "offset=" ~ offset ~ "&limit=" ~ rows_per_page %}

	{% if category %}
		{% set query_options = query_options ~ "&category__contains=" ~ category %}
	{% endif %}

	{# Query HubDB with limit + offset #}
	{% set table = hubdb_table_rows(
		dynamic_page_hubdb_table_id,
		query_options
	) %}

	{% set total_rows = table.totalCount %}
	{% set total_pages = (total_rows / rows_per_page)|round(0, 'ceil') %}

	{# Hide last 3 products in first load #}
	{% if request.query_dict.page is none %}
		{% set hide_product = true %}
	{% else %}
		{% set hide_product = false %}
	{% endif %}

	{# Retrieve categories #}
	{% set category_table = hubdb_table_rows(dynamic_page_hubdb_table_id) %}

	{% set categories = [] %}

	{% for row in category_table %}
		{% if row.category %}

			{# Split on ">" and take the first word #}
			{% set base_category = row.category|split('>')|first %}
			
			{% if base_category not in categories %}
				{% do categories.append(base_category) %}
			{% endif %}
		{% endif %}
	{% endfor %}

	{% set active_category = request.query_dict.category|default('') %}

	<section class="store">
		<div class="content-wrapper">
			<div class="store__categories-wrapper">
				<nav aria-label="Product categories">
					<ul class="store__categories">
						<li class="filter-btn--mobile">
							<button class="filter-btn__button">
								<div class="filter-btn__top"></div>
								<div class="filter-btn__middle"></div>
								<div class="filter-btn__bottom"></div>
							</button>
						</li>
						<li class="{{ 'active' if not active_category }}">
							<a class="btn--category btn--outline btn--small" href="?page=1">All</a>
						</li>
						{% for category in categories %}
							<li class="{{ 'active' if category == active_category }}">
								<a class="btn--category btn--outline btn--small" href="?page=1&category={{ category }}">
									{{ category }}
								</a>
							</li>
						{% endfor %}
					</ul>
				</nav>
			</div>

			<div class="store__products">
				{% if table|length %}
					{% for row in table %}
						<div
							id="store__product"
							class="store__product {{ loop.index > 6 and hide_product ? 'store__product--hidden' : '' }}"
						>
							<div class="store__product-media">
								<a class="store__product-img-wrapper" href="{{request.path}}/{{row.hs_path}}">
									<img
										class="store__product-img"
										src="{{ row.image.url }}"
										alt="{{ row.image.altText }}"
										height="216"
										width="384"
									>
								</a>
							</div>
							<div class="store__product-content">
								<h2 class="store__product-title">
									<a class="store__product-link" href="{{request.path}}/{{row.hs_path}}">
										{{ row.hs_name }}
									</a>
								</h2>
								<p class="store__product-price">
									{{ row.price|format_currency_value(locale='en-US', currency='USD', maxDecimalDigits=6, minDecimalDigits=2) }} USD
								</p>
								<div class="store__product-desc">
									{{ row.short_description }}
								</div>
							</div>
							<div class="store__product-cta">
								<a class="btn--store btn--outline-secondary btn--small" href="{{request.path}}/{{row.hs_path}}">
									Learn More
								</a>
							</div>
						</div>
					{% endfor %}
				{% else %}
					<h2>No products found.</h2>
				{% endif %}
			</div>
	
			<div class="btn__view-more-wrapper {{ !hide_product ? 'btn__view-more-wrapper--hidden' : '' }}">
				<button class="btn__view-more">
					View More
				</button>
			</div>

			{# Pagination #}

			{% if total_pages >= 1 %}
				<nav class="store__pagination {{ hide_product ? 'store__pagination--hidden' : '' }}" aria-label="Pagination">
					<ul class="pagination">
						{# Previous #}
						{% if current_page > 1 %}
							<li>
								<a class="pagination__previous" href="?page={{ current_page - 1 }}{% if category %}&category={{ category }}{% endif %}">
									<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" viewBox="0 0 320 512">
										<path d="M9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l192 192c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256 246.6 86.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-192 192z"/>
									</svg>
								</a>
							</li>
						{% endif %}
	
						{# Page numbers #}
						{% for page in range(1, total_pages + 1) %}
							<li class="{{ 'active' if page == current_page }}">
								<a class="pagination__number" href="?page={{ page }}{% if category %}&category={{ category }}{% endif %}">
									{{ page }}
								</a>
							</li>
						{% endfor %}
	
						{# Next #}
						{% if current_page < total_pages %}
							<li>
								<a class="pagination__next" href="?page={{ current_page + 1 }}{% if category %}&category={{ category }}{% endif %}">
									<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" viewBox="0 0 320 512">
										<path d="M311.1 233.4c12.5 12.5 12.5 32.8 0 45.3l-192 192c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L243.2 256 73.9 86.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l192 192z"/>
									</svg>
								</a>
							</li>
						{% endif %}
					</ul>
				</nav>
			{% endif %}
		</div>
	</section>
{% endif %}